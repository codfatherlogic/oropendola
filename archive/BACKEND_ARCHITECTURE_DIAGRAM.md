# Backend Architecture & Terminal Command Flow

## Current Architecture (Commands Blocked)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VS Code Extension                        â”‚
â”‚                     (Frontend/Client)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTPS POST Request
                      â”‚ /api/method/ai_assistant.api.execute_tool_call
                      â”‚ { action: "run_in_terminal", command: "npm install" }
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Frappe Backend Server                      â”‚
â”‚                  (Python/Frappe Framework)                   â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Endpoint: execute_tool_call()                   â”‚  â”‚
â”‚  â”‚  File: ai_assistant/api/chat.py                      â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  if action == "run_in_terminal":                     â”‚  â”‚
â”‚  â”‚      frappe.throw("Command Not Allowed")  â—„â”€â”€â”€â”€â”     â”‚  â”‚
â”‚  â”‚                                                 â”‚     â”‚  â”‚
â”‚  â”‚  if action == "create_file":                   â”‚     â”‚  â”‚
â”‚  â”‚      return create_file_handler() â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€âœ…  â”‚  â”‚
â”‚  â”‚                                                 â”‚     â”‚  â”‚
â”‚  â”‚  if action == "edit_file":                     â”‚     â”‚  â”‚
â”‚  â”‚      return edit_file_handler()  â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€âœ…  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                             â”‚        â”‚
â”‚                      â”‚ BLOCKED                     â”‚ ALLOWEDâ”‚
â”‚                      â–¼                             â–¼        â”‚
â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚              â”‚   âŒ Error   â”‚              â”‚ âœ… Success  â”‚â”‚
â”‚              â”‚  417/403     â”‚              â”‚   200 OK    â”‚â”‚
â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚                           â”‚
                      â”‚ Error Response            â”‚ Success Response
                      â”‚ "Command Not Allowed"     â”‚ "File created"
                      â”‚                           â”‚
                      â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VS Code Extension                        â”‚
â”‚                                                              â”‚
â”‚  Shows: âŒ Command failed: Command Not Allowed              â”‚
â”‚  Shows: âœ… Created package.json                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Proposed Architecture (Whitelist-Based)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VS Code Extension                        â”‚
â”‚                     (Frontend/Client)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ HTTPS POST Request
                      â”‚ { action: "run_in_terminal", command: "npm install" }
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   Frappe Backend Server                      â”‚
â”‚                  (Enhanced with Security)                    â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Endpoint: execute_tool_call()                   â”‚  â”‚
â”‚  â”‚  File: ai_assistant/api/chat.py                      â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  if action == "run_in_terminal":                     â”‚  â”‚
â”‚  â”‚      return execute_terminal_command(command)        â”‚  â”‚
â”‚  â”‚             â”‚                                         â”‚  â”‚
â”‚  â”‚             â–¼                                         â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚  â”‚
â”‚  â”‚  â”‚  Security Validator                         â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  File: utils/tool_executor.py               â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  1. Parse command: shlex.split()            â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     ["npm", "install"]                      â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  2. Check whitelist:                        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     ALLOWED_COMMANDS = {                    â”‚    â”‚  â”‚
â”‚  â”‚  â”‚       "npm": ["install", "start"],          â”‚    â”‚  â”‚
â”‚  â”‚  â”‚       "git": ["status", "log"]              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     }                                        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  3. Check blacklist:                        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     BLOCKED = ["rm", "sudo", "curl"]        â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  4. Validate patterns:                      â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     No pipes (|), redirects (>), etc.       â”‚    â”‚  â”‚
â”‚  â”‚  â”‚                                              â”‚    â”‚  â”‚
â”‚  â”‚  â”‚  5. Validate working directory:             â”‚    â”‚  â”‚
â”‚  â”‚  â”‚     Must be in /workspace/*                 â”‚    â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚  â”‚
â”‚  â”‚                 â”‚               â”‚                    â”‚  â”‚
â”‚  â”‚            âœ… ALLOWED      âŒ BLOCKED                â”‚  â”‚
â”‚  â”‚                 â”‚               â”‚                    â”‚  â”‚
â”‚  â”‚                 â–¼               â–¼                    â”‚  â”‚
â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚        â”‚  Execute in    â”‚  â”‚ Return Error â”‚        â”‚  â”‚
â”‚  â”‚        â”‚  subprocess    â”‚  â”‚  Message     â”‚        â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                 â”‚                 â”‚                 â”‚  â”‚
â”‚  â”‚                 â–¼                 â–¼                 â”‚  â”‚
â”‚  â”‚        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚  â”‚
â”‚  â”‚        â”‚ stdout/stderr  â”‚  â”‚ "Command not â”‚        â”‚  â”‚
â”‚  â”‚        â”‚ exit_code=0    â”‚  â”‚  whitelisted"â”‚        â”‚  â”‚
â”‚  â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚  â”‚
â”‚  â”‚                 â”‚                 â”‚                 â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                      â”‚                                     â”‚
â”‚                      â–¼ JSON Response                      â”‚
â”‚  {                                                         â”‚
â”‚    "success": true,                                        â”‚
â”‚    "stdout": "added 150 packages",                        â”‚
â”‚    "stderr": "",                                           â”‚
â”‚    "exit_code": 0                                          â”‚
â”‚  }                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Success Response
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     VS Code Extension                        â”‚
â”‚                                                              â”‚
â”‚  Shows: âœ… Executed: npm install                            â”‚
â”‚  Shows: ğŸ“¦ added 150 packages in 5s                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   User's Command Request                   â”‚
â”‚                   "npm install express"                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         Layer 1: Command Parser         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ shlex.split(command)              â”‚  â”‚
        â”‚  â”‚ Result: ["npm", "install", ...]   â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Valid Syntax                â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      Layer 2: Blacklist Check           â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ if cmd in BLOCKED_COMMANDS:       â”‚  â”‚
        â”‚  â”‚   - rm, sudo, curl, wget, etc.    â”‚  â”‚
        â”‚  â”‚   raise PermissionError           â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Not Blacklisted             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      Layer 3: Whitelist Check           â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ if cmd not in ALLOWED_COMMANDS:   â”‚  â”‚
        â”‚  â”‚   raise PermissionError           â”‚  â”‚
        â”‚  â”‚                                   â”‚  â”‚
        â”‚  â”‚ Whitelist:                        â”‚  â”‚
        â”‚  â”‚   npm: [install, start, test]     â”‚  â”‚
        â”‚  â”‚   git: [status, log, branch]      â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Whitelisted                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Layer 4: Argument Validation         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ if arg not in ALLOWED_ARGS:       â”‚  â”‚
        â”‚  â”‚   raise PermissionError           â”‚  â”‚
        â”‚  â”‚                                   â”‚  â”‚
        â”‚  â”‚ Example:                          â”‚  â”‚
        â”‚  â”‚   npm install âœ…                  â”‚  â”‚
        â”‚  â”‚   npm install --unsafe âŒ         â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Valid Arguments              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚    Layer 5: Pattern Detection           â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Check for:                        â”‚  â”‚
        â”‚  â”‚   - Pipes (|)                     â”‚  â”‚
        â”‚  â”‚   - Redirects (>, >>)             â”‚  â”‚
        â”‚  â”‚   - Command substitution ($, `)   â”‚  â”‚
        â”‚  â”‚   - Chaining (&&, ||, ;)          â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… No Dangerous Patterns       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Layer 6: Working Directory Check       â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Validate cwd:                     â”‚  â”‚
        â”‚  â”‚   - Must be in /workspace/*       â”‚  â”‚
        â”‚  â”‚   - Cannot be /bin, /etc, /usr    â”‚  â”‚
        â”‚  â”‚   - Must exist and be accessible  â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Safe Directory               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚       Layer 7: Execution Limits         â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ subprocess.run(                   â”‚  â”‚
        â”‚  â”‚   timeout=30,        # Max 30s    â”‚  â”‚
        â”‚  â”‚   shell=False,       # No shell   â”‚  â”‚
        â”‚  â”‚   check=False        # No throw   â”‚  â”‚
        â”‚  â”‚ )                                 â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Executed Safely              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚         Layer 8: Logging & Audit        â”‚
        â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
        â”‚  â”‚ Log:                              â”‚  â”‚
        â”‚  â”‚   - User who executed             â”‚  â”‚
        â”‚  â”‚   - Command executed              â”‚  â”‚
        â”‚  â”‚   - Timestamp                     â”‚  â”‚
        â”‚  â”‚   - Result (exit code)            â”‚  â”‚
        â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
        â”‚           âœ… Logged for Audit            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚   Return Result   â”‚
                â”‚  to VS Code UI    â”‚
                â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## File Structure

```
frappe-bench/
â””â”€â”€ apps/
    â””â”€â”€ ai_assistant/
        â”œâ”€â”€ ai_assistant/
        â”‚   â”œâ”€â”€ __init__.py
        â”‚   â”‚
        â”‚   â”œâ”€â”€ api/
        â”‚   â”‚   â”œâ”€â”€ __init__.py
        â”‚   â”‚   â””â”€â”€ chat.py                  # Main API endpoints
        â”‚   â”‚       â”œâ”€â”€ execute_tool_call()  # Entry point
        â”‚   â”‚       â””â”€â”€ chat_completion()    # AI chat
        â”‚   â”‚
        â”‚   â”œâ”€â”€ utils/
        â”‚   â”‚   â”œâ”€â”€ __init__.py
        â”‚   â”‚   â”œâ”€â”€ tool_executor.py         # â­ ADD THIS
        â”‚   â”‚   â”‚   â”œâ”€â”€ execute_terminal_command()
        â”‚   â”‚   â”‚   â”œâ”€â”€ validate_command()
        â”‚   â”‚   â”‚   â”œâ”€â”€ check_whitelist()
        â”‚   â”‚   â”‚   â””â”€â”€ get_safe_workspace_path()
        â”‚   â”‚   â”‚
        â”‚   â”‚   â””â”€â”€ security.py              # â­ ADD THIS
        â”‚   â”‚       â”œâ”€â”€ ALLOWED_COMMANDS
        â”‚   â”‚       â”œâ”€â”€ BLOCKED_COMMANDS
        â”‚   â”‚       â””â”€â”€ validate_patterns()
        â”‚   â”‚
        â”‚   â””â”€â”€ config/
        â”‚       â””â”€â”€ allowed_commands.json    # â­ ADD THIS
        â”‚
        â”œâ”€â”€ setup.py
        â””â”€â”€ hooks.py
```

---

## Data Flow Example

### Example 1: Allowed Command (npm install)

```
Step 1: Frontend sends request
POST /api/method/ai_assistant.api.execute_tool_call
{
  "action": "run_in_terminal",
  "command": "npm install"
}

Step 2: Backend parses command
shlex.split("npm install") â†’ ["npm", "install"]

Step 3: Security validation
âœ… Not in blacklist (rm, sudo, curl)
âœ… In whitelist (npm: [install, start, test])
âœ… Valid argument (install)
âœ… No dangerous patterns (|, >, &&)
âœ… Safe directory (/workspace/project)

Step 4: Execute
subprocess.run(
  ["npm", "install"],
  cwd="/workspace/project",
  timeout=30
)

Step 5: Return result
{
  "success": true,
  "stdout": "added 150 packages in 5.2s",
  "stderr": "",
  "exit_code": 0
}

Step 6: Frontend shows
âœ… Executed: npm install
ğŸ“¦ added 150 packages in 5.2s
```

---

### Example 2: Blocked Command (rm -rf)

```
Step 1: Frontend sends request
POST /api/method/ai_assistant.api.execute_tool_call
{
  "action": "run_in_terminal",
  "command": "rm -rf /"
}

Step 2: Backend parses command
shlex.split("rm -rf /") â†’ ["rm", "-rf", "/"]

Step 3: Security validation
âŒ BLOCKED: "rm" in BLOCKED_COMMANDS
   Reason: Dangerous file deletion command

Step 4: Return error
{
  "success": false,
  "message": "Command 'rm' is blocked for security reasons",
  "exit_code": 403
}

Step 5: Frontend shows
âŒ Command blocked: rm -rf /
âš ï¸  Dangerous file deletion command
```

---

### Example 3: Dangerous Pattern (npm install && rm -rf)

```
Step 1: Frontend sends request
POST /api/method/ai_assistant.api.execute_tool_call
{
  "action": "run_in_terminal",
  "command": "npm install && rm -rf /"
}

Step 2: Backend parses command
shlex.split() â†’ may succeed or fail
command contains "&&"

Step 3: Security validation
âœ… Not in blacklist
âœ… In whitelist
âŒ BLOCKED: Contains dangerous pattern "&&"
   Reason: Command chaining could execute malicious code

Step 4: Return error
{
  "success": false,
  "message": "Command contains dangerous pattern: &&",
  "exit_code": 403
}

Step 5: Frontend shows
âŒ Command blocked: npm install && rm -rf /
âš ï¸  Dangerous pattern detected
```

---

## Summary

### Current State
```
Request: npm install
  â†“
Backend: âŒ Command Not Allowed
  â†“
Result: Nothing executed
```

### After Fix
```
Request: npm install
  â†“
Backend: âœ… Validates (7 security layers)
  â†“
Execute: subprocess.run(safe_command)
  â†“
Result: âœ… Command executed successfully
```

### Security Guarantees

âœ… **Only whitelisted commands** can execute
âœ… **Dangerous commands** are blocked
âœ… **Command chaining** is prevented
âœ… **Working directory** is restricted
âœ… **Execution time** is limited
âœ… **All actions** are logged
âœ… **No shell injection** possible (shell=False)

This architecture provides **safe terminal execution** while maintaining **strong security**! ğŸ”’âœ…
